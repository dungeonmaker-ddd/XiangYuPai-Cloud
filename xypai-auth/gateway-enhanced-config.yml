spring:
  data:
    redis:
      host: localhost
      port: 6379
      password:
      timeout: 6000ms
      database: 0
      lettuce:
        pool:
          max-active: 100
          max-wait: -1ms
          max-idle: 20
          min-idle: 5
  cloud:
    gateway:
      # å…¨å±€é…ç½®
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOriginPatterns: "*"
            allowedMethods: "*"
            allowedHeaders: "*"
            allowCredentials: true
            exposedHeaders: "Content-Length,Content-Range"
            maxAge: 3600
      
      discovery:
        locator:
          lowerCaseServiceId: true
          enabled: true
      
      routes:
        # ğŸ“± APPç«¯è®¤è¯æœåŠ¡ (å¢å¼ºé…ç½®)
        - id: xypai-auth-app
          uri: lb://xypai-auth-app-auth
          predicates:
            - Path=/auth/**
          filters:
            # éªŒè¯ç å¤„ç† (ä»…ç”¨æˆ·åå¯†ç ç™»å½•éœ€è¦)
            - name: CacheRequestBody
            - name: ValidateCodeFilter
              args:
                # æŒ‡å®šéœ€è¦éªŒè¯ç çš„è·¯å¾„
                include-paths:
                  - /auth/login
                # æ’é™¤ä¸éœ€è¦éªŒè¯ç çš„è·¯å¾„
                exclude-paths:
                  - /auth/login/sms
                  - /auth/sms/send
                  - /auth/logout
                  - /auth/refresh
                  - /auth/info
                  - /auth/validate
            # ç§»é™¤è·¯å¾„å‰ç¼€
            - StripPrefix=1
            # é™æµé…ç½®
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 100
                redis-rate-limiter.burstCapacity: 200
                redis-rate-limiter.requestedTokens: 1
                key-resolver: "#{@ipKeyResolver}"
            # é‡è¯•é…ç½®
            - name: Retry
              args:
                retries: 3
                statuses: BAD_GATEWAY
                methods: GET,POST
                backoff:
                  firstBackoff: 50ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: false

        # ğŸ›ï¸ ç®¡ç†ç«¯è®¤è¯æœåŠ¡
        - id: xypai-auth-admin
          uri: lb://xypai-auth-admin
          predicates:
            - Path=/admin/**
          filters:
            # ç®¡ç†ç«¯å¼ºåˆ¶éªŒè¯ç 
            - CacheRequestBody
            - ValidateCodeFilter
            # ç®¡ç†ç«¯IPé™åˆ¶ (å¯é€‰)
            - name: RemoteAddr
              args:
                sources:
                  - 127.0.0.1
                  - 192.168.0.0/16
                  - 10.0.0.0/8
            - StripPrefix=1
            # ç®¡ç†ç«¯æ›´ä¸¥æ ¼çš„é™æµ
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 20
                redis-rate-limiter.burstCapacity: 50
                redis-rate-limiter.requestedTokens: 1
                key-resolver: "#{@ipKeyResolver}"

        # ğŸ“± APPä¸šåŠ¡æœåŠ¡
        - id: xypai-auth-app-business
          uri: lb://xypai-auth-app
          predicates:
            - Path=/app/**
          filters:
            # TokenéªŒè¯è¿‡æ»¤å™¨
            - name: AuthGatewayFilter
              args:
                # éœ€è¦è®¤è¯çš„è·¯å¾„
                auth-paths:
                  - /app/user/**
                  - /app/order/**
                  - /app/payment/**
                # å…¬å¼€è·¯å¾„ (æ— éœ€è®¤è¯)
                public-paths:
                  - /app/public/**
                  - /app/health
            - StripPrefix=1

        # ğŸŒ Webç«¯è®¤è¯æœåŠ¡ (æ–°å¢)
        - id: xypai-auth-web
          uri: lb://xypai-auth-web
          predicates:
            - Path=/web/auth/**
          filters:
            - CacheRequestBody
            - ValidateCodeFilter
            - StripPrefix=2

        # ä»£ç ç”Ÿæˆ (å¢å¼º)
        - id: xypai-gen
          uri: lb://xypai-gen
          predicates:
            - Path=/code/**
          filters:
            - name: AuthGatewayFilter
              args:
                # ä»£ç ç”Ÿæˆéœ€è¦ç®¡ç†å‘˜æƒé™
                required-roles:
                  - ROLE_ADMIN
                  - ROLE_DEVELOPER
            - StripPrefix=1

        # å®šæ—¶ä»»åŠ¡ (å¢å¼º)
        - id: xypai-job
          uri: lb://xypai-job
          predicates:
            - Path=/schedule/**
          filters:
            - name: AuthGatewayFilter
              args:
                required-roles:
                  - ROLE_ADMIN
            - StripPrefix=1

        # ç³»ç»Ÿæ¨¡å— (å¢å¼º)
        - id: xypai-system
          uri: lb://xypai-system
          predicates:
            - Path=/system/**
          filters:
            - name: AuthGatewayFilter
              args:
                # éƒ¨åˆ†ç³»ç»Ÿæ¥å£éœ€è¦è®¤è¯
                auth-paths:
                  - /system/user/**
                  - /system/role/**
                  - /system/menu/**
                  - /system/dept/**
                public-paths:
                  - /system/captcha/**
                  - /system/dict/**
            - StripPrefix=1

        # æ–‡ä»¶æœåŠ¡ (å¢å¼º)
        - id: xypai-file
          uri: lb://xypai-file
          predicates:
            - Path=/file/**
          filters:
            - name: AuthGatewayFilter
              args:
                # æ–‡ä»¶ä¸Šä¼ éœ€è¦è®¤è¯ï¼Œä¸‹è½½å¯å…¬å¼€
                auth-paths:
                  - /file/upload/**
                  - /file/delete/**
                public-paths:
                  - /file/download/**
                  - /file/preview/**
            # æ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶
            - name: RequestSize
              args:
                maxSize: 50MB
            - StripPrefix=1

        # ğŸ”” æ¶ˆæ¯é€šçŸ¥æœåŠ¡ (æ–°å¢)
        - id: xypai-notification
          uri: lb://xypai-notification
          predicates:
            - Path=/notification/**
          filters:
            - name: AuthGatewayFilter
            - StripPrefix=1

        # ğŸ“Š ç›‘æ§æœåŠ¡ (æ–°å¢)
        - id: xypai-monitor
          uri: lb://xypai-monitor
          predicates:
            - Path=/monitor/**
          filters:
            - name: AuthGatewayFilter
              args:
                required-roles:
                  - ROLE_ADMIN
            - StripPrefix=1

# å®‰å…¨é…ç½® (å¢å¼º)
security:
  # éªŒè¯ç é…ç½®
  captcha:
    enabled: true
    type: math
    # éªŒè¯ç æœ‰æ•ˆæœŸ (åˆ†é’Ÿ)
    expiration: 5
    # éªŒè¯ç ä½æ•°
    length: 4
    # éªŒè¯ç å­—ç¬¦é›†
    charset: "23456789ABCDEFGHJKLMNPQRSTUVWXYZ"
    # æ¯æ—¥åŒä¸€IPæœ€å¤§è·å–æ¬¡æ•°
    daily-limit: 100

  # XSSé˜²æŠ¤é…ç½®
  xss:
    enabled: true
    excludeUrls:
      - /system/notice
      - /file/upload/**
      - /*/api-docs
    # XSSè¿‡æ»¤çº§åˆ«: BASIC, RELAXED, STRICT
    filter-level: RELAXED

  # CSRFé…ç½®
  csrf:
    enabled: false
    # CSRF tokenæœ‰æ•ˆæœŸ (å°æ—¶)
    token-validity: 12

  # è®¿é—®æ§åˆ¶é…ç½®
  access:
    # æ˜¯å¦å¼€å¯IPé»‘åå•
    ip-blacklist-enabled: true
    # ç™»å½•å¤±è´¥é”å®šé…ç½®
    login-failure:
      # æœ€å¤§å¤±è´¥æ¬¡æ•°
      max-attempts: 5
      # é”å®šæ—¶é—´ (åˆ†é’Ÿ)
      lock-duration: 30
      # é”å®šèŒƒå›´: IP, USER, IP_AND_USER
      lock-scope: IP_AND_USER

  # è®¤è¯ç™½åå• (å¢å¼º)
  ignore:
    whites:
      # è®¤è¯ç›¸å…³
      - /auth/login
      - /auth/login/sms
      - /auth/sms/send
      - /auth/logout
      - /admin/auth/login
      - /admin/auth/logout
      - /web/auth/login
      - /web/auth/logout
      
      # æ³¨å†Œç›¸å…³ (æ–°å¢)
      - /auth/register
      - /auth/register/verify
      - /auth/password/reset
      - /auth/password/reset/verify
      
      # æ–‡æ¡£å’Œå¥åº·æ£€æŸ¥
      - /*/v2/api-docs
      - /*/v3/api-docs
      - /*/swagger-resources/**
      - /*/webjars/**
      - /*/doc.html
      - /*/favicon.ico
      - /actuator/health
      - /actuator/info
      
      # é™æ€èµ„æº
      - /static/**
      - /public/**
      - /assets/**
      
      # éªŒè¯ç å’Œå­—å…¸
      - /system/captcha/**
      - /system/dict/data/**
      - /file/download/**
      - /file/preview/**
      
      # WebSocket (å¦‚éœ€è¦)
      - /websocket/**
      
      # æ”¯ä»˜å›è°ƒ (å¦‚éœ€è¦)
      - /payment/callback/**
      - /payment/notify/**

# JWTé…ç½® (æ–°å¢)
jwt:
  # JWTå¯†é’¥
  secret: xypai-auth-secret-key-2024
  # Tokenæœ‰æ•ˆæœŸé…ç½® (å°æ—¶)
  expiration:
    web: 12      # Webç«¯12å°æ—¶
    app: 168     # Appç«¯7å¤©  
    admin: 2     # ç®¡ç†ç«¯2å°æ—¶
    mini: 24     # å°ç¨‹åº24å°æ—¶
  # åˆ·æ–°Tokenæœ‰æ•ˆæœŸ (å¤©)
  refresh-expiration: 30

# é™æµé…ç½®
rate-limit:
  # å…¨å±€é™æµ
  global:
    replenish-rate: 1000
    burst-capacity: 2000
  # æŒ‰æ¥å£é™æµ
  endpoints:
    "/auth/login":
      replenish-rate: 10
      burst-capacity: 20
    "/auth/sms/send":
      replenish-rate: 1
      burst-capacity: 5
    "/admin/auth/login":
      replenish-rate: 5
      burst-capacity: 10

# ç›‘æ§é…ç½®
monitoring:
  # é“¾è·¯è¿½è¸ª
  tracing:
    enabled: true
    sample-rate: 0.1
  # æŒ‡æ ‡æ”¶é›†
  metrics:
    enabled: true
    # éœ€è¦ç›‘æ§çš„è·¯å¾„
    include-patterns:
      - /auth/**
      - /admin/**
      - /system/**
    # æ’é™¤çš„è·¯å¾„
    exclude-patterns:
      - /actuator/**
      - /*/api-docs

# Swaggeræ–‡æ¡£èšåˆé…ç½®
springdoc:
  api-docs:
    enabled: true
    path: /v3/api-docs
  swagger-ui:
    enabled: true
    path: /swagger-ui.html
    config-url: /v3/api-docs/swagger-config
  webjars:
    prefix: /webjars

# æ—¥å¿—é…ç½®
logging:
  level:
    com.xypai.auth: INFO
    org.springframework.cloud.gateway: DEBUG
    org.springframework.security: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level [%X{traceId},%X{spanId}] %logger{36} - %msg%n"
