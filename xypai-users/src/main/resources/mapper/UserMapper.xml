<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- üèóÔ∏è XYÁõ∏ÈÅáÊ¥æÁî®Êà∑Êï∞ÊçÆËÆøÈóÆÊò†Â∞Ñ - ‰ºÅ‰∏öÊû∂ÊûÑÂÆûÁé∞ (MP QueryWrapperÁâàÊú¨) -->
<!-- 
    ÈáçÊûÑËØ¥ÊòéÔºö
    1. Â§ßÂπÖÁÆÄÂåñXMLÊò†Â∞ÑÔºåÂè™‰øùÁïôÂ§çÊùÇÁöÑSQLÊü•ËØ¢
    2. Âü∫Á°ÄCRUDÊìç‰Ωú‰ΩøÁî®MPÁöÑBaseMapper
    3. Êù°‰ª∂Êü•ËØ¢‰ΩøÁî®LambdaQueryWrapper
    4. Âè™‰øùÁïôÁ°ÆÂÆûÈúÄË¶ÅÂ§çÊùÇSQLÁöÑÁªüËÆ°Âíå‰∏öÂä°Êü•ËØ¢
-->
<mapper namespace="com.xypai.user.mapper.UserMapper">

    <!-- ================================ -->
    <!-- üìä Â§çÊùÇÁªüËÆ°Êü•ËØ¢ (‰øùÁïôXMLÂÆûÁé∞) -->
    <!-- ================================ -->

    <!-- 
        ËØ¥ÊòéÔºö‰ª•‰∏ãÊü•ËØ¢‰ΩøÁî®‰∫ÜÂ§çÊùÇÁöÑSQLÈÄªËæëÔºåÂ¶ÇCASE WHEN„ÄÅÂ≠êÊü•ËØ¢Á≠âÔºå
        Ëøô‰∫õÊü•ËØ¢Áî®XMLÂÆûÁé∞ÊØîQueryWrapperÊõ¥Ê∏ÖÊô∞ÊòìÁª¥Êä§
    -->

    <!-- ÊåâÁî®Êà∑Á±ªÂûãÁªüËÆ° - Â∏¶‰∏≠ÊñáÊèèËø∞ -->
    <select id="countByUserType" resultType="Map">
        SELECT user_type AS type,
               COUNT(*)  AS count,
               CASE user_type
                   WHEN 0 THEN 'ÊôÆÈÄöÁî®Êà∑'
                   WHEN 1 THEN 'VIPÁî®Êà∑'
                   WHEN 2 THEN 'SVIPÁî®Êà∑'
                   WHEN 3 THEN '‰ºÅ‰∏öÁî®Êà∑'
                   ELSE 'Êú™Áü•'
                   END   AS typeName
        FROM xypai_users
        WHERE del_flag = '0'
          AND status = 1
        GROUP BY user_type
        ORDER BY user_type
    </select>

    <!-- ÊåâÂπ≥Âè∞ÁªüËÆ° -->
    <select id="countByPlatform" resultType="Map">
        SELECT platform,
               COUNT(*) AS count
        FROM xypai_users
        WHERE del_flag = '0'
          AND platform IS NOT NULL
        GROUP BY platform
        ORDER BY count DESC
    </select>

    <!-- ÊåâÊ≥®ÂÜåÊ∏†ÈÅìÁªüËÆ° -->
    <select id="countBySourceChannel" resultType="Map">
        SELECT source_channel AS channel,
               COUNT(*)       AS count
        FROM xypai_users
        WHERE del_flag = '0'
          AND source_channel IS NOT NULL
        GROUP BY source_channel
        ORDER BY count DESC
    </select>

    <!-- Âú∞Âå∫ÂàÜÂ∏ÉTOPÁªüËÆ° - Âä®ÊÄÅLIMIT -->
    <select id="getTopLocationStats" resultType="Map">
        SELECT location,
               COUNT(*) AS count
        FROM xypai_users
        WHERE del_flag = '0'
          AND location IS NOT NULL
          AND location != ''
        GROUP BY location
        ORDER BY count DESC
        LIMIT #{limit}
    </select>

    <!-- Áî®Êà∑Ê¥ªË∑ÉÂ∫¶ÁªºÂêàÁªüËÆ° - Â§çÊùÇÁªüËÆ°ÈÄªËæë -->
    <select id="getUserActivityStats" resultType="Map">
        SELECT COUNT(*)                                                                        AS totalUsers,
               COUNT(CASE WHEN last_login_time >= DATE_SUB(NOW(), INTERVAL 1 DAY) THEN 1 END)  AS activeToday,
               COUNT(CASE WHEN last_login_time >= DATE_SUB(NOW(), INTERVAL 7 DAY) THEN 1 END)  AS activeWeek,
               COUNT(CASE WHEN last_login_time >= DATE_SUB(NOW(), INTERVAL 30 DAY) THEN 1 END) AS activeMonth,
               COUNT(CASE WHEN create_time >= DATE_SUB(NOW(), INTERVAL 1 DAY) THEN 1 END)      AS newToday,
               COUNT(CASE WHEN create_time >= DATE_SUB(NOW(), INTERVAL 7 DAY) THEN 1 END)      AS newWeek,
               COUNT(CASE WHEN create_time >= DATE_SUB(NOW(), INTERVAL 30 DAY) THEN 1 END)     AS newMonth
        FROM xypai_users
        WHERE del_flag = '0'
          AND status = 1
    </select>

    <!-- ================================ -->
    <!-- üîß ‰∏öÂä°ËæÖÂä©ÊñπÊ≥ï (Â§çÊùÇÈÄªËæë) -->
    <!-- ================================ -->

    <!-- ÁîüÊàê‰∏ã‰∏Ä‰∏™Áî®Êà∑ÁºñÁ†Å - Â§çÊùÇÁöÑÁºñÁ†ÅÁîüÊàêÈÄªËæë -->
    <select id="generateNextUserCode" resultType="String">
        SELECT CONCAT('XY', DATE_FORMAT(NOW(), '%Y%m%d'),
                      LPAD(IFNULL(MAX(SUBSTRING(user_code, -4)), 0) + 1, 4, '0'))
        FROM xypai_users
        WHERE user_code LIKE CONCAT('XY', DATE_FORMAT(NOW(), '%Y%m%d'), '%')
    </select>

    <!-- Êü•ËØ¢Áî®Êà∑Ê≥®ÂÜåË∂ãÂäø - Êó•ÊúüÂàÜÁªÑÁªüËÆ° -->
    <select id="getUserRegistrationTrend" resultType="Map">
        SELECT DATE(create_time) AS date,
               COUNT(*)          AS count
        FROM xypai_users
        WHERE create_time BETWEEN #{startTime} AND #{endTime}
          AND del_flag = '0'
        GROUP BY DATE(create_time)
        ORDER BY date
    </select>

    <!-- ================================ -->
    <!-- üîÑ ÊâπÈáèÊìç‰Ωú (ÊÄßËÉΩ‰ºòÂåñ) -->
    <!-- ================================ -->

    <!-- ÊâπÈáèÊõ¥Êñ∞Áî®Êà∑Áä∂ÊÄÅ - ‰ΩøÁî®@UpdateÊ≥®Ëß£ÂÆûÁé∞ÔºåËøôÈáå‰ªÖ‰ΩúÂ§á‰ªΩ -->
    <!-- 
    <update id="batchUpdateStatus">
        UPDATE xypai_users 
        SET status = #{newStatus}, 
            update_by = #{operatorId}, 
            update_time = NOW()
        WHERE user_id IN
        <foreach collection="userIds" item="userId" open="(" close=")" separator=",">
            #{userId}
        </foreach>
        AND del_flag = '0'
    </update>
    -->

    <!-- Êõ¥Êñ∞ÁôªÂΩï‰ø°ÊÅØ - ‰ΩøÁî®@UpdateÊ≥®Ëß£ÂÆûÁé∞ÔºåËøôÈáå‰ªÖ‰ΩúÂ§á‰ªΩ -->
    <!-- 
    <update id="updateLoginInfo">
        UPDATE xypai_users 
        SET last_login_time = NOW(),
            last_login_ip = #{loginIp},
            login_count = login_count + 1
        WHERE user_id = #{userId} AND del_flag = '0'
    </update>
    -->

</mapper>